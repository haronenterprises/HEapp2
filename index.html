<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haron Enterprises, LLC - Residential Lease Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chosen Palette: Professional Neutral -->
    <!-- Application Structure Plan: Multi-step wizard with client-side PDF generation (most reliable method without a server). -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            background-color: #f8f7f4; 
            font-family: 'Inter', sans-serif;
        }
        @import url('https://rsms.me/inter/inter.css');
        .form-section {
            display: none;
        }
        .form-section.active {
            display: block;
        }
        .step-item-active {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        .step-item-complete {
            border-color: #16a34a;
            color: #16a34a;
            background-color: #f0fdf4;
        }
        .input-field {
            @apply w-full px-2 py-1 text-gray-700 bg-white border border-gray-300 rounded-sm text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200;
        }
        .label-text {
            @apply block text-sm font-medium text-gray-800 py-1;
        }
        /* START: FIX for Red X on dynamic items */
        .dynamic-item .remove-btn { 
            display: none; 
        }
        .dynamic-item:hover .remove-btn {
            display: block; 
        }
        /* END: FIX for Red X on dynamic items */
        /* Style for print output */
        @media print {
            body { background: #fff; }
            #navigation-controls, #progress-bar, #header, #footer, #application-wizard { display: none !important; }
            .printable-only { display: block !important; }
            .print-button { display: none !important; }
            .no-print { display: none !important; }
        }
        .printable-only {
            display: none;
        }
        /* Custom styles for the 3-column data section */
        .data-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr; /* Custom widths for Description, Applicant, Co-Applicant */
            gap: 1rem; /* Spacing between columns */
        }
        @media (max-width: 768px) {
            .data-grid {
                grid-template-columns: 1fr; /* Stack columns on mobile */
            }
        }
        .description-col {
            font-weight: 500;
            color: #1f2937; /* Gray-800 */
            padding-top: 0.35rem; /* Align with input */
            padding-bottom: 0.35rem; /* Align with input */
            line-height: 2.25rem; /* Match height of input container */
        }
        .field-container {
            min-height: 40px; /* Ensures consistent vertical alignment */
            display: flex;
            align-items: center;
        }
        .input-label-row {
            line-height: 2.25rem; /* Ensures vertical alignment for text fields */
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto px-4 py-8 md:py-12 no-print">
        <header id="header" class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Haron Enterprises, LLC</h1>
            <p class="mt-2 text-lg text-gray-600">Residential Lease Application</p>
            <p class="text-sm text-gray-600 font-semibold">In Accordance with Seminole County NSP Rentals Program</p>
            <p class="text-sm text-red-600 font-bold">AII INCOMPLETE applications will be REJECTED. Tel: (407) 702-3281 / Fax: (866) 858-5371</p>
            <p class="text-sm text-gray-500">Eff date 10 01 25 v50.4</p>
        </header>

        <div id="application-wizard" class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
            <div id="progress-bar" class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div id="step-1" class="step-item step-item-active text-center w-1/6">
                        <div class="border-b-4 pb-2 text-xs md:text-sm font-semibold">Checklist</div>
                    </div>
                     <div id="step-2" class="step-item text-center w-1/6">
                        <div class="border-b-4 border-gray-200 pb-2 text-xs md:text-sm font-semibold text-gray-400">Address</div>
                    </div>
                     <div id="step-3" class="step-item text-center w-1/6">
                        <div class="border-b-4 border-gray-200 pb-2 text-xs md:text-sm font-semibold text-gray-400">Household</div>
                    </div>
                     <div id="step-4" class="step-item text-center w-1/6">
                        <div class="border-b-4 border-gray-200 pb-2 text-xs md:text-sm font-semibold text-gray-400">Financial</div>
                    </div>
                     <div id="step-5" class="step-item text-center w-1/6">
                        <div class="border-b-4 border-gray-200 pb-2 text-xs md:text-sm font-semibold text-gray-400">History</div>
                    </div>
                    <div id="step-6" class="step-item text-center w-1/6">
                        <div class="border-b-4 border-gray-200 pb-2 text-xs md:text-sm font-semibold text-gray-400">Final</div>
                    </div>
                </div>
            </div>

            <!-- CRITICAL FIX: Removed action attribute entirely for self-contained operation -->
            <form id="rental-application-form" class="p-6 md:p-8">
                <div id="status-message" class="text-sm px-4 py-2 rounded-md mb-4 hidden" role="alert"></div>
                
                <!-- START: SECTION 1 (Intro/Checklist) - SIMPLEST LAYOUT FOR TESTING -->
                <section id="section-1" class="form-section active">
                    <h2 class="text-2xl font-semibold mb-3 text-gray-800">APPLICATION CHECKLIST (TEST MODE)</h2>
                    <p class="text-red-500 font-semibold mb-6 border-b pb-4">ONLY FILL NAME AND DATE TO TEST ADVANCEMENT.</p>
                    
                    <div class="space-y-6">
                        
                        <div class="border p-4 rounded-lg bg-gray-50">
                            <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-1">Basic Identification</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="label-text" for="fullName">Full Name</label><input type="text" id="fullName" name="Full Name" class="input-field" required></div>
                                <div><label class="label-text" for="date">Date</label><input type="text" id="date" name="Date" class="input-field" required readonly></div>
                            </div>
                        </div>
                        <!-- Checkboxes REMOVED for testing -->
                    </div>
                </section>
                <!-- END: SECTION 1 (Intro/Checklist) -->

                <!-- START: SECTION 2 (Applicant Details & Rental History - 3 COLUMN LAYOUT) -->
                <section id="section-2" class="form-section">
                    
                    <!-- Section 2.1: Applicant/Co-Applicant Data (3-Column Layout) -->
                    <div class="data-grid space-y-4 border p-4 rounded-lg bg-white shadow-sm">
                        
                        <!-- Row 1: Headers (b) -->
                        <div class="text-sm font-bold description-col border-b pb-2 text-gray-800">DESCRIPTION</div>
                        <div class="text-sm font-bold text-center border-b pb-2 text-gray-800">APPLICANT</div>
                        <div class="text-sm font-bold text-center border-b pb-2 text-gray-800">CO-APPLICANT</div>

                        <!-- Row 2: Full Name -->
                        <div class="description-col input-label-row">Full Name</div>
                        <div class="field-container"><input type="text" id="full_name_app" name="Full Name Applicant" class="input-field" required></div>
                        <div class="field-container"><input type="text" id="full_name_co" name="Full Name CoApplicant" class="input-field"></div>
                        
                        <!-- Row 3: Date of Birth -->
                        <div class="description-col input-label-row">Date of Birth</div>
                        <div class="field-container"><input type="date" id="dob_app" name="DOB Applicant" class="input-field" required></div>
                        <div class="field-container"><input type="date" id="dob_co" name="DOB CoApplicant" class="input-field"></div>
                        
                        <!-- Row 4: Social Security Number (d, e) -->
                        <div class="description-col input-label-row">Social Security Number</div>
                        <div class="field-container"><input type="text" id="ssn_app" name="SSN Applicant" class="input-field" required pattern="[0-9]{9}" title="9 numerical digits required"></div>
                        <div class="field-container"><input type="text" id="ssn_co" name="SSN CoApplicant" class="input-field" pattern="[0-9]{9}" title="9 numerical digits required"></div>

                        <!-- Row 5: Driver's License # (d) -->
                        <div class="description-col input-label-row">Driver's License #</div>
                        <div class="field-container"><input type="text" id="dl_app" name="DL Applicant" class="input-field" required></div>
                        <div class="field-container"><input type="text" id="dl_co" name="DL CoApplicant" class="input-field"></div>

                        <!-- Row 6: Phone (d, f) -->
                        <div class="description-col input-label-row">Phone</div>
                        <div class="field-container"><input type="tel" id="phone_app" name="Phone Applicant" class="input-field" required pattern="[0-9]{10}" title="10 numerical digits required"></div>
                        <div class="field-container"><input type="tel" id="phone_co" name="Phone CoApplicant" class="input-field" pattern="[0-9]{10}" title="10 numerical digits required"></div>

                        <!-- Row 7: Email Address (d, g) -->
                        <div class="description-col input-label-row">Email Address</div>
                        <div class="field-container"><input type="email" id="email_app" name="Email Applicant" class="input-field" required></div>
                        <div class="field-container"><input type="email" id="email_co" name="Email CoApplicant" class="input-field"></div>

                         <!-- Row 8: Armed Services -->
                         <div class="description-col input-label-row">Armed Services Member?</div>
                         <div class="field-container">
                             <div class="radio-group justify-center w-full">
                                 <label class="radio-label"><input type="radio" name="Armed Services App" value="yes" class="radio-input mr-1">Yes</label>
                                 <label class="radio-label"><input type="radio" name="Armed Services App" value="no" class="radio-input mr-1" checked>No</label>
                             </div>
                         </div>
                          <div class="field-container">
                              <div class="radio-group justify-center w-full">
                                 <label class="radio-label"><input type="radio" name="Armed Services CoApp" value="yes" class="radio-input mr-1">Yes</label>
                                 <label class="radio-label"><input type="radio" name="Armed Services CoApp" value="no" class="radio-input mr-1" checked>No</label>
                             </div>
                         </div>

                        <!-- Row 9: Vehicle Make & Model -->
                        <div class="description-col input-label-row">Vehicle Make & Model</div>
                        <div class="field-container"><input type="text" id="vehicleMake_app" name="Vehicle Make Applicant" class="input-field"></div>
                        <div class="field-container"><input type="text" id="vehicleMake_co" name="Vehicle Make CoApplicant" class="input-field"></div>

                        <!-- Row 10: Vehicle Tag # -->
                        <div class="description-col input-label-row">Vehicle Tag #</div>
                        <div class="field-container"><input type="text" id="vehicleTag_app" name="Vehicle Tag Applicant" class="input-field"></div>
                        <div class="field-container"><input type="text" id="vehicleTag_co" name="Vehicle Tag CoApplicant" class="input-field"></div>
                        
                        <!-- Row 11: Name of Nearest Relative -->
                        <div class="description-col input-label-row">Name of Nearest Relative</div>
                        <div class="field-container"></div> <!-- Applicant doesn't have a nearest relative field here -->
                        <div class="field-container"><input type="text" id="relativeName" name="Name of Nearest Relative" class="input-field"></div>

                        <!-- Row 12: Phone of Nearest Relative -->
                        <div class="description-col input-label-row">Phone of Nearest Relative</div>
                        <div class="field-container"></div> <!-- Applicant doesn't have a nearest relative field here -->
                        <div class="field-container"><input type="tel" id="relativePhone" name="Phone Nearest Relative" class="input-field" pattern="[0-9]{10}" title="10 numerical digits required"></div>
                        
                        <!-- Row 13: Ever Been Evicted -->
                         <div class="description-col input-label-row">Ever Been Evicted?</div>
                         <div class="field-container">
                             <div class="radio-group justify-center w-full">
                                 <label class="radio-label"><input type="radio" name="Evicted App" value="yes" class="radio-input mr-1">Yes</label>
                                 <label class="radio-label"><input type="radio" name="Evicted App" value="no" class="radio-input mr-1" checked>No</label>
                             </div>
                         </div>
                          <div class="field-container">
                              <div class="radio-group justify-center w-full">
                                 <label class="radio-label"><input type="radio" name="Evicted CoApp" value="yes" class="radio-input mr-1">Yes</label>
                                 <label class="radio-label"><input type="radio" name="Evicted CoApp" value="no" class="radio-input mr-1" checked>No</label>
                             </div>
                         </div>
                         
                         <!-- Row 14: Ever Been Foreclosed -->
                         <div class="description-col input-label-row">Ever Been Foreclosed?</div>
                         <div class="field-container">
                             <div class="radio-group justify-center w-full">
                                 <label class="radio-label"><input type="radio" name="Foreclosed App" value="yes" class="radio-input mr-1">Yes</label>
                                 <label class="radio-label"><input type="radio" name="Foreclosed App" value="no" class="radio-input mr-1" checked>No</label>
                             </div>
                         </div>
                          <div class="field-container">
                              <div class="radio-group justify-center w-full">
                                 <label class="radio-label"><input type="radio" name="Foreclosed CoApp" value="yes" class="radio-input mr-1">Yes</label>
                                 <label class="radio-label"><input type="radio" name="Foreclosed CoApp" value="no" class="radio-input mr-1" checked>No</label>
                             </div>
                         </div>
                    </div>

                    <!-- Rental History Section -->
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-1">Current Address</h3>
                        
                        <!-- Current Address is required and static -->
                        <div class="mt-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div class="md:col-span-2"><label class="label-text" for="currentStreet">Street Address</label><input type="text" id="currentStreet" name="Current Street Address" class="input-field" required></div>
                                <div><label class="label-text" for="currentCity">City</label><input type="text" id="currentCity" name="Current City" class="input-field" required></div>
                                <div><label class="label-text" for="currentState">State</label><input type="text" id="currentState" name="Current State" class="input-field" required></div>
                                <div><label class="label-text" for="currentZip">Zip Code</label><input type="text" id="currentZip" name="Current Zip Code" class="input-field" required></div>
                                
                                <div><label class="label-text" for="currentContact">Contact Person</label><input type="text" id="currentContact" name="Current Contact Person" class="input-field" required></div>
                                <div><label class="label-text" for="currentTitle">Title</label><input type="text" id="currentTitle" name="Current Contact Title" class="input-field" required></div>
                                
                                <div><label class="label-text" for="timeAtCurrentFrom">From Date (mm/dd/yyyy)</label><input type="text" id="timeAtCurrentFrom" name="Time At Current From Date" class="input-field" required pattern="\d{2}/\d{2}/\d{4}" placeholder="MM/DD/YYYY"></div>
                                <div><label class="label-text" for="currentMonthlyRent">Monthly Rent</label><input type="number" id="currentMonthlyRent" name="Current Monthly Rent" class="input-field" required min="0"></div>

                                <div><label class="label-text" for="securityDepositReturn">Security Deposit Return %</label><input type="text" id="securityDepositReturn" name="Security Deposit Return Percent" class="input-field" required></div>
                                <div><label class="label-text" for="reasonForLeaving">Reason For Leaving</label><input type="text" id="reasonForLeaving" name="Reason For Leaving" class="input-field" required></div>
                                
                                <div class="md:col-span-2"><label class="label-text" for="currentLandlord">Current Landlord/Mortgage Co.</label><input type="text" id="currentLandlord" name="Current Landlord/Mortgage Co." class="input-field" required></div>
                                <div><label class="label-text" for="currentLandlordPhone">Landlord Phone</label><input type="tel" id="currentLandlordPhone" name="Current Landlord Phone" class="input-field" required></div>
                                
                                
                            </div>
                        </div>

                         <!-- Previous Address Dynamic Blocks (Hidden by default) -->
                         <div id="prev-address-container-wrapper" class="hidden mt-6">
                            <h3 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-1">Previous Address History (Required)</h3>
                            <div id="prev-address-container" class="space-y-4"></div>
                         </div>
                    </div>
                </section>
                <!-- END: SECTION 2 (Applicant Details & Rental History) -->


                <!-- START: SECTION 3 (Household Members & Citizenship) -->
                <section id="section-3" class="form-section">
                    <h2 class="text-2xl font-semibold mb-2 text-gray-800">Household & Citizenship Details</h2>
                    <p class="text-gray-600 mb-6">PLACEHOLDER SECTION - Fill Page 2 to continue to Page 4.</p>
                </section>
                <!-- END: SECTION 3 (Household Members & Citizenship) -->


                <!-- START: SECTION 4 (Financial & Employment - Placeholder) -->
                <section id="section-4" class="form-section">
                    <h2 class="text-2xl font-semibold mb-2 text-gray-800">Financial & Employment Information</h2>
                    <p class="text-gray-600 mb-6">PLACEHOLDER SECTION - Fill Page 1 to continue to Page 5.</p>
                </section>
                <!-- END: SECTION 4 (Financial & Employment - Placeholder) -->

                <section id="section-5" class="form-section">
                    <h2 class="text-2xl font-semibold mb-2 text-gray-800">Background & History</h2>
                    <p class="text-gray-600 mb-6">PLACEHOLDER SECTION - Fill Page 1 to continue to Page 6.</p>
                </section>

                <section id="section-6" class="form-section">
                    <h2 class="text-2xl font-semibold mb-2 text-gray-800">Authorizations & Agreement</h2>
                    <p class="text-gray-600 mb-6">You're almost done! Please read the following legal statements carefully. Your agreement is required to finalize and submit your application for review.</p>
                    <div class="prose prose-sm max-w-none text-gray-600 bg-gray-50 p-4 rounded-md border border-gray-200">
                        <p><strong>Text:</strong> I/We understand that Florida Statute 817 provides that a person is guilty of a misdemeanor in the first degree who knowingly makes a false statement in writing with the intent to mislead a landlord in repairing or leasing a dwelling unit. I CERTIFY THAT ALL THE INFORMATION PROVIDED IN THIS APPLICATION IS TRUE AND CORRECT. I, the undersigned applicant, affirm the information above is true and complete and authorize Haron Enterprises, LLC to make any and all inquiries necessary to verify said information, including but not limited to, direct contact with any person, business, or agency named above. I also understand that any false information on this application may cause this application to be rejected and may be grounds for immediate termination of the lease at the owner's option. I also agree to all the terms and conditions in the rental agreement, should this application be accepted.</p>
                    </div>
                    <div class="mt-6">
                        <label class="flex items-center">
                            <input type="checkbox" id="agree-terms" name="agreement" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" required>
                            <span class="ml-3 text-gray-700">By checking this box, you attest that all information provided is true and accurate, and you agree to the terms and authorizations.</span>
                        </label>
                    </div>
                     <div class="mt-8 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
                        <h3 class="font-semibold text-blue-800">Final Step: Application Fee</h3>
                        <p class="text-sm text-blue-700 mt-1">A non-refundable processing fee of $50.00 is required. This fee must be paid prior to an application being accepted or processed. Upon submitting, you will be contacted with payment instructions.</p>
                    </div>
                </section>
            </form>
            
            <div id="navigation-controls" class="p-6 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                <button type="button" id="prev-btn" class="px-6 py-2 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-100 transition-colors duration-200" style="display: none;">Previous</button>
                <div id="spacer" style="display: block;"></div>
                <button type="button" id="next-btn" class="px-6 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors duration-200">Next</button>
                <button type="button" id="submit-btn" class="px-6 py-2 text-sm font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors duration-200" style="display: none;">Submit Application</button>
            </div>
        </div>
    </div>
    
    <!-- PDF Generation/Print Summary Section (Hidden until Submission) -->
    <div id="print-summary" class="printable-only"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let currentStep = 1;
            const totalSteps = 6;
            const form = document.getElementById('rental-application-form');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');
            const spacer = document.getElementById('spacer');

            // Set current date on Page 1
            const today = new Date();
            const yyyy = today.getFullYear();
            let mm = today.getMonth() + 1; // Months start at 0
            let dd = today.getDate();
            if (dd < 10) dd = '0' + dd;
            if (mm < 10) mm = '0' + mm;
            document.getElementById('date').value = `${mm}/${dd}/${yyyy}`;
            
            // Helper function to update button visibility and style
            const updateButtons = () => {
                prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
                spacer.style.display = currentStep === 1 ? 'block' : 'none';
                nextBtn.style.display = currentStep < totalSteps ? 'block' : 'none';
                submitBtn.style.display = currentStep === totalSteps ? 'block' : 'none';
            };

            // Helper function to update the progress bar style
            const updateProgressBar = () => {
                for (let i = 1; i <= totalSteps; i++) {
                    const step = document.getElementById(`step-${i}`);
                    step.classList.remove('step-item-active', 'step-item-complete');
                    step.querySelector('div').classList.remove('border-blue-500', 'text-blue-600', 'border-green-500', 'text-green-600', 'bg-green-50');
                    step.querySelector('div').classList.add('border-gray-200', 'text-gray-400');

                    if (i < currentStep) {
                        step.classList.add('step-item-complete');
                        step.querySelector('div').classList.add('border-green-500', 'text-green-600');
                    } else if (i === currentStep) {
                        step.classList.add('step-item-active');
                        step.querySelector('div').classList.add('border-blue-500', 'text-blue-600');
                    }
                }
            };
            
            // Helper function to show the current section
            const showSection = (step) => {
                document.querySelectorAll('.form-section').forEach(section => section.classList.remove('active'));
                document.getElementById(`section-${step}`).classList.add('active');
            };

            // Helper function to calculate residency duration
            const calculateResidencyDuration = (fromDateStr, toDateStr) => {
                // Parses MM/DD/YYYY string into Date object
                const parseDate = (dateStr) => {
                    if (!/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) return null;
                    const parts = dateStr.split('/');
                    const date = new Date(parts[2], parts[0] - 1, parts[1]);
                    // Basic check to ensure the date parts made a valid date
                    if (date.getFullYear() != parts[2] || date.getMonth() != parts[0] - 1 || date.getDate() != parts[1]) {
                        return null;
                    }
                    return date;
                };

                const fromDate = parseDate(fromDateStr);
                const toDate = parseDate(toDateStr);

                if (!fromDate || !toDate || fromDate >= toDate) {
                    return 0; // Return 0 if dates are invalid or reversed
                }

                // Calculate difference in months
                let months = (toDate.getFullYear() - fromDate.getFullYear()) * 12;
                months -= fromDate.getMonth();
                months += toDate.getMonth();
                return months;
            };

            // Helper function to show/hide previous address based on 4-year rule
            const togglePreviousAddress = () => {
                const fromDateInput = document.getElementById('timeAtCurrentFrom');
                const toDateInput = document.getElementById('timeAtCurrentTo');
                const wrapper = document.getElementById('prev-address-container-wrapper');
                
                // Get all inputs inside the previous address container
                const prevInputs = document.querySelectorAll('#prev-address-container input');

                // Check if date fields are filled and valid (required by their pattern)
                if (fromDateInput.checkValidity() && toDateInput.checkValidity() && fromDateInput.value && toDateInput.value) {
                    const durationMonths = calculateResidencyDuration(fromDateInput.value, toDateInput.value);
                    
                    if (durationMonths < 48 && durationMonths > 0) { // Less than 4 years (48 months) but more than 0 months
                        wrapper.classList.remove('hidden');
                        // Make inputs required when visible
                        prevInputs.forEach(input => input.setAttribute('required', ''));
                        // Ensure at least one previous address block exists if required
                        if (document.querySelectorAll('#prev-address-container .dynamic-item').length === 0) {
                            createPrevAddressBlock(); 
                        }
                    } else {
                        wrapper.classList.add('hidden');
                        // Remove required attribute when hidden
                        prevInputs.forEach(input => input.removeAttribute('required'));
                    }
                } else {
                    // Hide and remove required if dates are not valid or not filled
                    wrapper.classList.add('hidden');
                    prevInputs.forEach(input => input.removeAttribute('required'));
                }
            };
            
            // START: CRITICAL FIX v49.7 for Next button not working (Direct Validation)
            nextBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const currentSection = document.getElementById(`section-${currentStep}`);
                
                // Find the first required input in the current section
                const firstInvalidInput = currentSection.querySelector(':invalid');

                // If an invalid input exists, force the browser to show the error
                if (firstInvalidInput) {
                    firstInvalidInput.reportValidity();
                    return; // Stop execution
                }

                // If on Section 2, perform the residency check after validation
                if (currentStep === 2) {
                    togglePreviousAddress(); // Ensure this runs after the current fields are validated
                    const wrapper = document.getElementById('prev-address-container-wrapper');
                    
                    // Re-check validation if Previous Address history became required
                    if (!wrapper.classList.contains('hidden')) {
                        const firstInvalidPrevious = wrapper.querySelector(':invalid');
                        if (firstInvalidPrevious) {
                            firstInvalidPrevious.reportValidity();
                            return;
                        }
                    }
                }
                
                // If valid, advance the page
                if (currentStep < totalSteps) {
                    currentStep++;
                    showSection(currentStep);
                    updateButtons();
                    updateProgressBar();
                    window.scrollTo(0, 0);
                }
            });
            // END: CRITICAL FIX v49.7 for Next button not working (Direct Validation)

            prevBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentStep > 1) {
                    currentStep--;
                    showSection(currentStep);
                    updateButtons();
                    updateProgressBar();
                    window.scrollTo(0, 0);
                }
            });
            
            // START: Submit button logic
            submitBtn.addEventListener('click', (e) => {
                e.preventDefault();
                
                const agreeCheckbox = document.getElementById('agree-terms');

                // 1. Final Validation Check (Page 6 Edit)
                if (!agreeCheckbox.checkValidity()) {
                    agreeCheckbox.reportValidity(); 
                    return;
                }
                
                // 2. Data Collection and Formatting (Placeholder logic for PDF Generation)
                // NOTE: This logic should be expanded in the final version to include all fields
                const formData = new FormData(form);
                let reportHTML = `<div class="p-8 bg-white border border-gray-300 rounded-lg shadow-xl print-container">
                    <header class="text-center mb-6 border-b pb-4">
                        <h1 class="text-2xl font-bold">HARON ENTERPRISES, LLC</h1>
                        <h2 class="text-xl">FINAL APPLICATION SUMMARY</h2>
                        <p class="text-xs text-gray-500">Generated: ${new Date().toLocaleDateString()}</p>
                    </header>
                    <h3 class="text-lg font-semibold mt-6 border-b pb-1">Applicant Data Collected</h3>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-2 mt-2 text-sm">
                        <!-- Display captured data (Simplified) -->
                        <div class="col-span-1"><span class="font-medium">Full Name:</span> ${formData.get('Full Name')}</div>
                        <div class="col-span-1"><span class="font-medium">Date of Birth:</span> ${formData.get('Date of Birth')}</div>
                        <div class="col-span-2 mt-4 text-center"><p class="text-red-600 font-bold">This is the final document. Please click the button below to save to PDF.</p></div>
                    </div>
                
                    <div class="mt-8 text-center">
                        <button class="print-button px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg" onclick="window.print()">✅ Save to PDF / Print Final Application</button>
                    </div>
                </div>`;

                // 3. Display the Final Document
                document.body.innerHTML = reportHTML; // Replace the entire body content with the summary
                window.scrollTo(0, 0); // Scroll to top of the new page
            });
            // END: Submit button logic

            // START: Dynamic content block functions (Necessary for Add Member, etc.)
            const createDynamicBlock = (containerId, titlePrefix, innerHTMLCallback) => {
                const container = document.getElementById(containerId);
                const count = container.querySelectorAll('.dynamic-item').length + 1;
                const newBlock = document.createElement('div');
                newBlock.className = 'p-4 border border-gray-200 rounded-lg relative dynamic-item';
                newBlock.innerHTML = `
                    <button type="button" class="absolute top-2 right-2 text-red-500 hover:text-red-700 remove-btn" onclick="this.parentElement.remove(); togglePreviousAddress()">&#x2715;</button>
                    <h4 class="font-semibold mb-2 text-sm">${titlePrefix} ${count}</h4>
                    ${innerHTMLCallback(count)}
                `;
                container.appendChild(newBlock);
            };

            // Previous Address Dynamic Block Creator
            const createPrevAddressBlock = () => {
                 createDynamicBlock('prev-address-container', 'Previous Address', (count) => `
                     <div class="space-y-2">
                        <div><label class="label-text text-xs">Street Address</label><input type="text" name="Previous Address ${count} Street" class="input-field text-sm" required></div>
                        <div><label class="label-text text-xs">City/State/Zip</label><input type="text" name="Previous Address ${count} CityStateZip" class="input-field text-sm" required></div>
                        <div><label class="label-text text-xs">Time at Residence</label><input type="text" name="Previous Address ${count} Time" class="input-field text-sm" required></div>
                        <div><label class="label-text text-xs">Landlord Name/Phone</label><input type="text" name="Previous Address ${count} Landlord Contact" class="input-field text-sm" required></div>
                    </div>`);
            };
            // END: Dynamic content block functions

            // Initial setup
            showSection(1);
            updateButtons();
            updateProgressBar();
            
            // Attach event listeners for date fields to check residency duration
            const dateFields = [
                document.getElementById('timeAtCurrentFrom'), 
                document.getElementById('timeAtCurrentTo')
            ];

            dateFields.forEach(field => {
                field.addEventListener('input', () => {
                    // Only trigger check if the date format is valid
                    if (field.checkValidity()) { 
                        togglePreviousAddress();
                    }
                });
            });
            
            // Event listener for adding more previous addresses
            document.getElementById('add-prev-address-btn').addEventListener('click', createPrevAddressBlock);

            // Initial address block setup (one block by default, required status is set by togglePreviousAddress)
            // Create an initial block but keep it empty of required fields until the toggle function runs.
            const initialPrevBlockContainer = document.getElementById('prev-address-container');
            if (initialPrevBlockContainer.children.length === 0) {
                createPrevAddressBlock();
            }
            document.getElementById('prev-address-container-wrapper').classList.add('hidden');
            document.querySelectorAll('#prev-address-container input').forEach(input => input.removeAttribute('required'));
        });
    </script>
</body>
</html>
